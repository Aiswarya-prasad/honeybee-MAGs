---
title: "Honeybee cross-species analysis - 11"
author: Aiswarya Prasad
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  prettydoc::html_pretty:
    theme: cayman
    <!-- other fun themes: architect leonids hpstr cayman -->
    highlight: github
    math: katex
    number_sections: true
    df_print: paged
    cold-folding: hide
    toc: true
---

# Initialization

To intialize complete all of or relevant sections of `scripts/visualization/Load_data.R`.

```{r}
df_cdhit_clusters_info <- read.csv("results/08_gene_content/00_cdhit_clustering/cluster_info.tsv", sep = "\t")
hist(df_cdhit_clusters_info %>% pull(num_genes))

ggplot(df_cdhit_clusters_info) +
  geom_histogram(aes(x = num_genes, fill = factor(num_hosts), group = num_hosts), binwidth = 1) +
  make_theme()

ggplot(df_cdhit_clusters_info %>% filter(num_genes > 50)) +
  geom_histogram(aes(x = num_genes, fill = factor(num_hosts), group = num_hosts), binwidth = 1) +
  make_theme()

ggplot(df_cdhit_clusters_info %>% filter(num_genes < 50)) +
  geom_histogram(aes(x = num_genes, fill = factor(num_hosts), group = num_hosts), binwidth = 1) +
  make_theme()

df_clusters_host_info <- df_cdhit_clusters_info %>%
  mutate(host_summarised = if_else(hosts == "M", "Apis mellifera", 
             if_else(hosts == "C", "Apis cerana", 
             if_else(hosts == "D", "Apis dorsata", 
             if_else(hosts == "F", "Apis florea", 
             if_else(hosts == "A", "Apis andreniformis", "Mixed"))))))
                          
ggplot(df_clusters_host_info) +
  geom_histogram(aes(x = num_genes, fill = factor(host_summarised), group = host_summarised), binwidth = 1) +
  scale_fill_manual(values = host_order_color) +
  make_theme(setFill = FALSE)

ggplot(df_clusters_host_info %>% filter(representative_GH != "NA")) +
  geom_bar(aes(x = representative_GH, 
               fill = factor(host_summarised))) +
  scale_fill_manual(values = host_order_color) +
  make_theme(setFill = FALSE)

# df_clusters_host_info order by count of GH
gh_order <- df_clusters_host_info %>%
  filter(representative_GH != "NA") %>%
  group_by(representative_GH) %>%
  mutate(count = n()) %>%
  unique() %>%
  arrange(count) %>%
  pull(representative_GH) %>% unique()

ko_order <- df_clusters_host_info %>%
  filter(representative_KO != "NA") %>%
  group_by(representative_KO) %>%
  mutate(count = n()) %>%
  unique() %>%
  arrange(count) %>%
  pull(representative_KO) %>% unique()

ggplot(df_clusters_host_info %>% 
        group_by(representative_GH) %>% 
        mutate(freq = n()) %>%
        filter(freq > 10) %>% 
        ungroup() %>%
        filter(representative_GH != "NA")) +
  labs(y = "CAZy GH family", x = "Count", fill = "Host") +
  geom_bar(aes(y = factor(representative_GH, gh_order), 
               fill = factor(host_summarised))) +
  scale_fill_manual(values = host_order_color) +
  make_theme(setFill = FALSE)
  ggsave("results/figures/11-GH_family_clusters_per_host_filt_10.pdf")

# heatmap of host vs GH and group by hierarchy

# read in gene profiling results
df_profiling <- data.frame()
for (sample in samples) {
  flagstat_path = paste0("/scratch/aprasad/20230313_apis_species_comparison/results/08_gene_content/01_profiling/", sample, "_mapped.flagstat")
  if (file.exists(flagstat_path)) {
    reads_mapped = get_read_count_from_flagstat(flagstat_path)
  }
  total = df_reads %>% filter(Sample == sample) %>% pull(Total_clean)
  unmapped = total - reads_mapped
  df_profiling <- rbind(df_profiling, c(sample, unmapped, reads_mapped))
}
colnames(df_profiling) <- c("sample", "b_Mapped_catalog", "a_Unmapped_catalog")
df_profiling$b_Mapped_catalog <- as.numeric(df_profiling$b_Mapped_catalog)
df_profiling$a_Unmapped_catalog <- as.numeric(df_profiling$a_Unmapped_catalog)
ggplot(df_profiling %>% pivot_longer(!sample, names_to = "type", values_to = "reads")) +
  geom_bar(aes(y = sample, 
               x = reads, 
              fill = type), stat = "identity", position = "stack"
              ) +
    make_theme(y_size = 5)
# Pcoa of KO families

df_ko_counts <- read.csv("/scratch/aprasad/20230313_apis_species_comparison/results/08_gene_content/03_gene_counts/ko_family_genes_matrix.txt", sep = "\t", stringsAsFactors = FALSE, na.strings=0)
df_gh_counts <- read.csv("/scratch/aprasad/20230313_apis_species_comparison/results/08_gene_content/03_gene_counts/GH_family_genes_matrix.txt", sep = "\t", stringsAsFactors = FALSE, na.strings=0)
colnames(df_ko_counts) = c("KO_group", unlist(lapply(colnames(df_ko_counts)[-1], function(x) convert_sample_name(x))))
colnames(df_gh_counts) = c("GH_group", unlist(lapply(colnames(df_gh_counts)[-1], function(x) convert_sample_name(x))))
ko_mat <- data.matrix(df_ko_counts)[,-1]
rownames(ko_mat) <- data.matrix(df_ko_counts)[,1]
gh_mat <- data.matrix(df_gh_counts)[,-1]
rownames(gh_mat) <- data.matrix(df_gh_counts)[,1]

heatmap(ko_mat)
heatmap(gh_mat)
distance_mat <- dist(t(ko_mat[, ]))
pcoa_plot(distance_mat, df_meta_complete, "Species", color_add = T, color_list = host_order_color_dark)

distance_mat_gh <- dist(t(gh_mat[, which(colSums(gh_mat) > 1)]))
pcoa_plot(distance_mat_gh, df_meta_complete, "Species", color_add = T, color_list = host_order_color_dark)

view(distance_mat)
view(df_meta_complete)


all_gene_counts <- read.csv("/scratch/aprasad/20230313_apis_species_comparison/results/08_gene_content/03_gene_counts/all_genes_matrix.txt", sep = "\t", stringsAsFactors = FALSE, na.strings=0)
colnames(all_gene_counts) = c("gene_ID", unlist(lapply(colnames(df_ko_counts)[-1], function(x) convert_sample_name(x))))
```

```{r gggenes}
library(gggenes)

```


```{r}
# visualize cazy

cazy_df <- read.csv("results/figures/cazy_df.tsv", sep = "\t") %>%
            filter(sample %in% samples) %>%
            mutate(Host = Vectorize(get_host_from_sample_name)(sample))
host_count <- cazy_df %>% group_by(Host) %>% summarize(count = n_distinct(sample))
get_prev <- function(present, host) {
  total <- pull(filter(host_count, Host == host), count)
  return(present / total)
}

cazy_df <- read.csv("results/figures/cazy_df.tsv", sep = "\t") %>%
            mutate(Host = Vectorize(get_host_from_sample_name)(sample)) %>%
              mutate(present = ifelse(uniq_rpkm > 0, 1, 0)) %>%
              group_by(feature, Host) %>%
              mutate(count = sum(present)) %>%
              ungroup() %>%
              mutate(Prevalence_host = Vectorize(get_prev)(count, Host))

# count is number of samples of host in which it is present
# present if uniq_rpkm > 0
order_feature_count <- cazy_df %>%
            group_by(feature) %>%
            mutate(sum = sum(count)) %>%
            arrange(sum) %>%
            pull(feature) %>% unique

order_feature_prev <- cazy_df %>% 
            reframe(feature, Host, present, Prevalence_host) %>%
            group_by(feature) %>%
            mutate(sum = sum(Prevalence_host)) %>%
            arrange(sum) %>%
            pull(feature) %>% unique

ggplot(cazy_df %>% reframe(feature, Host, count, Prevalence_host) %>% unique) +
  geom_tile(aes(x = Host, y = feature, fill = Prevalence_host)) +
  labs(y = "CAZy GH family", x = "Host", fill = "Prevalence") +
  scale_y_discrete(limits = order_feature_prev) +
  coord_fixed(ratio = 0.05) +
  make_theme(setFill = FALSE, leg_pos = "right", 
             x_angle = 45, x_size = 10,
             y_size = 6, y_hj = 1)


# completed_substrate_annotations <- read_xlsx("data/cayman_gene_db/20230607_glycan_annotations_cleaned.xlsx")
completed_substrate_annotations <- read.csv("data/cayman_gene_db/20230607_glycan_annotations_cleaned_manually.tsv", header = T, sep = "\t")
glycan_annotations_final_cleaned <- completed_substrate_annotations %>% select(c(Family:Subfamily,ORIGIN:FUNCTION_AT_DESTINATION_3, Glycan_annotation))
glycan_annotations_final_cleaned_long <- glycan_annotations_final_cleaned %>% separate_rows(ORIGIN,sep=",") %>% separate_rows(FUNCTION_IN_ORIGIN,sep=",") %>% separate_rows(FUNCTION_AT_DESTINATION_1,sep=",") %>% separate_rows(FUNCTION_AT_DESTINATION_2,sep=",") %>% separate_rows(FUNCTION_AT_DESTINATION_3,sep=",")
glycan_annotations_cleaned <- glycan_annotations_final_cleaned

glycan_annotations_cleaned_filt <- glycan_annotations_cleaned %>% filter(!is.na(FUNCTION_AT_DESTINATION_3))

# and abbreviate long glycan names
cazy_df_annotated <- cazy_df %>%
                      left_join(glycan_annotations_cleaned, by = c("feature" = "Subfamily")) %>%
                      mutate(mod_names_pec = ifelse(grepl("pectin", FUNCTION_AT_DESTINATION_3), 1, 0)) %>%
                      mutate(short_names = abbreviate(FUNCTION_AT_DESTINATION_3, minlength = 50))

write.csv(cazy_df_annotated, "results/figures/cazy_df_annotated.txt", row.names = FALSE, quote = FALSE)

# heatmap of Glycan_annotatoin vs host showing prevalence as size of dot
ggplot(cazy_df_annotated %>% filter(sample %in% samples_IN_MY) %>% filter(uniq_rpkm > 0) %>% filter(grepl("ectin", FUNCTION_AT_DESTINATION_3))) +
  geom_tile(aes(x = sample, y = feature, fill = uniq_rpkm)) +
  labs(y = "Cazyme family", x = "sample", fill = "uniq_rpkm") +
  scale_fill_viridis_c(trans = "log10") +
  new_scale_fill() +
  geom_tile(aes(x = sample, y = 0, fill = Host)) +
  scale_fill_manual(values = host_order_color) +
  make_theme(setFill = FALSE, leg_pos = "right", guide_nrow = 10, modify_guide = F,
             x_angle = 90, x_size = 0,
             x_hj = 10, x_vj = 1,
             y_size = 10, y_hj = 1)
             ggsave("results/figures/cazyme_uniq_rpkm_pectin_assoc_familes.pdf")

ggplot(cazy_df_annotated %>% filter(sample %in% samples_IN_MY) %>% filter(uniq_rpkm > 0)) +
# ggplot(cazy_df_annotated %>% filter(sample %in% samples_IN_MY) %>% filter(FUNCTION_AT_DESTINATION_3 != "Unknown") %>% filter(!is.na(FUNCTION_AT_DESTINATION_3))) +
  geom_tile(aes(x = sample, y = short_names, fill = uniq_rpkm)) +
  labs(y = "Cazyme family", x = "sample", fill = "uniq_rpkm") +
  scale_fill_viridis_c(trans = "log10") +
  new_scale_fill() +
  geom_tile(aes(x = sample, y = 0, fill = Host)) +
  scale_fill_manual(values = host_order_color) +
  make_theme(setFill = FALSE, leg_pos = "right", guide_nrow = 10, modify_guide = F,
             x_angle = 90, x_size = 0,
             x_hj = 10, x_vj = 1,
             y_size = 10, y_hj = 1)
             ggsave("results/figures/cazyme_uniq_rpkm_glyc_annotation.pdf")

# make this with complex heatmap and add glycan annotation

cazyme_uniq_mat_pec <- cazy_df_annotated %>%
                        select(sample, feature, uniq_rpkm) %>%
                        pivot_wider(names_from = sample, values_from = uniq_rpkm) %>%                        
                        column_to_rownames("feature") %>% as.matrix %>% 


column_ba <- HeatmapAnnotation(Host = colnames(cazyme_uniq_mat_pec) %>% as.data.frame() %>% mutate(Host = Vectorize(get_host_from_sample_name)(.)) %>% pull(Host),
                              col = list(Host = host_order_color
                              ), border = T
                          )
glycan_anno_names <- rownames(cazyme_uniq_mat_pec) %>% as.data.frame() %>% left_join(cazy_df_annotated %>% select(feature, short_names) %>% filter(!is.na(short_names)) %>% unique, by = c("." = "feature")) %>% pull(short_names) %>% replace_na(., "Unknown")
row_la <- rowAnnotation(Glycan = glycan_anno_names,
                        col = list(Glycan = make_col_list(glycan_anno_names)
                        ), border = T, show_legend = c(F)
                    )
column_split <- colnames(cazyme_uniq_mat_pec) %>% as.data.frame() %>% mutate(Host = Vectorize(get_host_from_sample_name)(.)) %>% pull(Host) %>% as.factor %>% as.character
row_split <- rownames(cazyme_uniq_mat_pec) %>% as.data.frame() %>% left_join(cazy_df_annotated %>% select(feature, short_names) %>% filter(!is.na(short_names)) %>% unique, by = c("." = "feature")) %>% pull(short_names) %>% replace_na(., "Unknown") %>% as.factor %>% as.character
col_fun = colorRamp2(c(0, 0.1, 1, 10, 1000), c(brewer.pal(9, "PuBu")[1], brewer.pal(9, "PuBu")[3], brewer.pal(9, "PuBu")[4], brewer.pal(9, "PuBu")[7], brewer.pal(9, "PuBu")[9]))
heatmap_obj = Heatmap(cazyme_uniq_mat_pec,
        # col = c("#e1ebf4", "#081d58"),
        col = col_fun,
        clustering_method_columns = 'ward.D2',
        column_split = column_split,
        row_split = row_split,
        column_dend_side = "bottom",
        column_title_gp = grid::gpar(fontsize = 0),
        row_title_gp = grid::gpar(fontsize = 12),
        row_title_rot = 0,
        # border = T,
        heatmap_legend_param = list(title = "RPKM (Unique)"),
        bottom_annotation = column_ba, 
        # right_annotation = row_ra,
        left_annotation = row_la,
        # top_annotation = column_ha,
        column_names_gp = grid::gpar(fontsize = 0),
        row_names_gp = grid::gpar(fontsize = 7),
          cluster_columns = F,
          cluster_rows = F)
draw(heatmap_obj, merge_legend = TRUE)
pdf("results/figures/cazyme_uniq_rpkm.pdf", width = 20, height = 25)
draw(heatmap_obj, merge_legend = TRUE)
dev.off()


# make_without unknown
cazy_df_annotated %>% select(feature, FUNCTION_AT_DESTINATION_3) %>% unique %>% filter(!is.na(FUNCTION_AT_DESTINATION_3)) %>% filter(!is.na(FUNCTION_AT_DESTINATION_3)) %>% filter(FUNCTION_AT_DESTINATION_3 != "Unknown") %>% pull(FUNCTION_AT_DESTINATION_3) %>% unique
known_families <- cazy_df_annotated %>% select(feature, FUNCTION_AT_DESTINATION_3) %>% unique %>% filter(!is.na(FUNCTION_AT_DESTINATION_3)) %>% filter(!is.na(FUNCTION_AT_DESTINATION_3)) %>% filter(FUNCTION_AT_DESTINATION_3 != "Unknown" & FUNCTION_AT_DESTINATION_3 != "") %>% pull(feature)
cazyme_uniq_mat_pec_no_na <- cazy_df_annotated %>%
                        filter(feature %in% known_families) %>%
                        select(sample, feature, uniq_rpkm) %>%
                        pivot_wider(names_from = sample, values_from = uniq_rpkm) %>%
                        column_to_rownames("feature") %>% as.matrix

column_ba <- HeatmapAnnotation(Host = colnames(cazyme_uniq_mat_pec_no_na) %>% as.data.frame() %>% mutate(Host = Vectorize(get_host_from_sample_name)(.)) %>% pull(Host),
                              col = list(Host = host_order_color
                              ), border = T
                          )
glycan_anno_names <- rownames(cazyme_uniq_mat_pec_no_na) %>% as.data.frame() %>% left_join(cazy_df_annotated %>% select(feature, short_names) %>% filter(!is.na(short_names)) %>% unique, by = c("." = "feature")) %>% pull(short_names) %>% replace_na(., "Unknown")
row_la <- rowAnnotation(Glycan = glycan_anno_names,
                        col = list(Glycan = make_col_list(glycan_anno_names)
                        ), border = T, show_legend = c(F)
                    )
column_split <- colnames(cazyme_uniq_mat_pec_no_na) %>% as.data.frame() %>% mutate(Host = Vectorize(get_host_from_sample_name)(.)) %>% pull(Host) %>% as.factor %>% as.character
row_split <- rownames(cazyme_uniq_mat_pec_no_na) %>% as.data.frame() %>% left_join(cazy_df_annotated %>% select(feature, short_names) %>% filter(!is.na(short_names)) %>% unique, by = c("." = "feature")) %>% pull(short_names) %>% replace_na(., "Unknown") %>% as.factor %>% as.character
col_fun = colorRamp2(c(0, 0.1, 1, 10, 1000), c(brewer.pal(9, "PuBu")[1], brewer.pal(9, "PuBu")[3], brewer.pal(9, "PuBu")[4], brewer.pal(9, "PuBu")[7], brewer.pal(9, "PuBu")[9]))
heatmap_obj = Heatmap(cazyme_uniq_mat_pec_no_na,
        # col = c("#e1ebf4", "#081d58"),
        col = col_fun,
        clustering_method_columns = 'ward.D2',
        column_split = column_split,
        row_split = row_split,
        column_dend_side = "bottom",
        column_title_gp = grid::gpar(fontsize = 0),
        row_title_gp = grid::gpar(fontsize = 12),
        row_title_rot = 0,
        # border = T,
        heatmap_legend_param = list(title = "RPKM (Unique)"),
        bottom_annotation = column_ba, 
        # right_annotation = row_ra,
        left_annotation = row_la,
        # top_annotation = column_ha,
        column_names_gp = grid::gpar(fontsize = 0),
        row_names_gp = grid::gpar(fontsize = 7),
        # show_row_dend = F,
        # show_column_dend = F,
          cluster_columns = F,
          cluster_rows = F)
draw(heatmap_obj, merge_legend = TRUE)
pdf("results/figures/cazyme_uniq_rpkm_no_unknown.pdf", width = 15, height = 25)
draw(heatmap_obj, merge_legend = TRUE)
dev.off()

cazy_df_annotated <- cazy_df %>%
                      left_join(glycan_annotations_cleaned, by = c("feature" = "Subfamily")) %>%
                      mutate(mod_names_pec = ifelse(grepl("pectin", FUNCTION_AT_DESTINATION_3), 1, 0)) %>%
                      mutate(short_names = abbreviate(FUNCTION_AT_DESTINATION_3, minlength = 50)) %>%
                      filter(sample %in% samples_IN_MY)

cazyme_uniq_mat_pec <- cazy_df_annotated %>%
                        select(sample, feature, uniq_rpkm) %>%
                        pivot_wider(names_from = sample, values_from = uniq_rpkm) %>%                        
                        column_to_rownames("feature") %>% as.matrix


column_ba <- HeatmapAnnotation(Host = colnames(cazyme_uniq_mat_pec) %>% as.data.frame() %>% mutate(Host = Vectorize(get_host_from_sample_name)(.)) %>% pull(Host),
                              col = list(Host = host_order_color
                              ), border = T
                          )
glycan_anno_names <- rownames(cazyme_uniq_mat_pec) %>% as.data.frame() %>% left_join(cazy_df_annotated %>% select(feature, short_names) %>% filter(!is.na(short_names)) %>% unique, by = c("." = "feature")) %>% pull(short_names) %>% replace_na(., "Unknown")
row_la <- rowAnnotation(Glycan = glycan_anno_names,
                        col = list(Glycan = make_col_list(glycan_anno_names)
                        ), border = T, show_legend = c(F)
                    )
column_split <- colnames(cazyme_uniq_mat_pec) %>% as.data.frame() %>% mutate(Host = Vectorize(get_host_from_sample_name)(.)) %>% pull(Host) %>% as.factor %>% as.character
row_split <- rownames(cazyme_uniq_mat_pec) %>% as.data.frame() %>% left_join(cazy_df_annotated %>% select(feature, short_names) %>% filter(!is.na(short_names)) %>% unique, by = c("." = "feature")) %>% pull(short_names) %>% replace_na(., "Unknown") %>% as.factor %>% as.character
col_fun = colorRamp2(c(0, 0.1, 1, 10, 1000), c(brewer.pal(9, "PuBu")[1], brewer.pal(9, "PuBu")[3], brewer.pal(9, "PuBu")[4], brewer.pal(9, "PuBu")[7], brewer.pal(9, "PuBu")[9]))
heatmap_obj = Heatmap(cazyme_uniq_mat_pec,
        # col = c("#e1ebf4", "#081d58"),
        col = col_fun,
        clustering_method_columns = 'ward.D2',
        column_split = column_split,
        row_split = row_split,
        column_dend_side = "bottom",
        column_title_gp = grid::gpar(fontsize = 0),
        row_title_gp = grid::gpar(fontsize = 12),
        row_title_rot = 0,
        # border = T,
        heatmap_legend_param = list(title = "RPKM (Unique)"),
        bottom_annotation = column_ba, 
        # right_annotation = row_ra,
        left_annotation = row_la,
        # top_annotation = column_ha,
        column_names_gp = grid::gpar(fontsize = 0),
        row_names_gp = grid::gpar(fontsize = 7),
          cluster_columns = F,
          cluster_rows = F)
draw(heatmap_obj, merge_legend = TRUE)
pdf("results/figures/cazyme_uniq_rpkm_IN_MY.pdf", width = 20, height = 25)
draw(heatmap_obj, merge_legend = TRUE)
dev.off()


# make_without unknown
cazy_df_annotated %>% select(feature, FUNCTION_AT_DESTINATION_3) %>% unique %>% filter(!is.na(FUNCTION_AT_DESTINATION_3)) %>% filter(!is.na(FUNCTION_AT_DESTINATION_3)) %>% filter(FUNCTION_AT_DESTINATION_3 != "Unknown") %>% pull(FUNCTION_AT_DESTINATION_3) %>% unique
known_families <- cazy_df_annotated %>% select(feature, FUNCTION_AT_DESTINATION_3) %>% unique %>% filter(!is.na(FUNCTION_AT_DESTINATION_3)) %>% filter(!is.na(FUNCTION_AT_DESTINATION_3)) %>% filter(FUNCTION_AT_DESTINATION_3 != "Unknown" & FUNCTION_AT_DESTINATION_3 != "") %>% pull(feature)
cazyme_uniq_mat_pec_no_na <- cazy_df_annotated %>%
                        filter(feature %in% known_families) %>%
                        select(sample, feature, uniq_rpkm) %>%
                        pivot_wider(names_from = sample, values_from = uniq_rpkm) %>%
                        column_to_rownames("feature") %>% as.matrix

column_ba <- HeatmapAnnotation(Host = colnames(cazyme_uniq_mat_pec_no_na) %>% as.data.frame() %>% mutate(Host = Vectorize(get_host_from_sample_name)(.)) %>% pull(Host),
                              col = list(Host = host_order_color
                              ), border = T
                          )
glycan_anno_names <- rownames(cazyme_uniq_mat_pec_no_na) %>% as.data.frame() %>% left_join(cazy_df_annotated %>% select(feature, short_names) %>% filter(!is.na(short_names)) %>% unique, by = c("." = "feature")) %>% pull(short_names) %>% replace_na(., "Unknown")
row_la <- rowAnnotation(Glycan = glycan_anno_names,
                        col = list(Glycan = make_col_list(glycan_anno_names)
                        ), border = T, show_legend = c(F)
                    )
column_split <- colnames(cazyme_uniq_mat_pec_no_na) %>% as.data.frame() %>% mutate(Host = Vectorize(get_host_from_sample_name)(.)) %>% pull(Host) %>% as.factor %>% as.character
row_split <- rownames(cazyme_uniq_mat_pec_no_na) %>% as.data.frame() %>% left_join(cazy_df_annotated %>% select(feature, short_names) %>% filter(!is.na(short_names)) %>% unique, by = c("." = "feature")) %>% pull(short_names) %>% replace_na(., "Unknown") %>% as.factor %>% as.character
col_fun = colorRamp2(c(0, 0.1, 1, 10, 1000), c(brewer.pal(9, "PuBu")[1], brewer.pal(9, "PuBu")[3], brewer.pal(9, "PuBu")[4], brewer.pal(9, "PuBu")[7], brewer.pal(9, "PuBu")[9]))
heatmap_obj = Heatmap(cazyme_uniq_mat_pec_no_na,
        # col = c("#e1ebf4", "#081d58"),
        col = col_fun,
        clustering_method_columns = 'ward.D2',
        column_split = column_split,
        row_split = row_split,
        column_dend_side = "bottom",
        column_title_gp = grid::gpar(fontsize = 0),
        row_title_gp = grid::gpar(fontsize = 12),
        row_title_rot = 0,
        # border = T,
        heatmap_legend_param = list(title = "RPKM (Unique)"),
        bottom_annotation = column_ba, 
        # right_annotation = row_ra,
        left_annotation = row_la,
        # top_annotation = column_ha,
        column_names_gp = grid::gpar(fontsize = 0),
        row_names_gp = grid::gpar(fontsize = 7),
        # show_row_dend = F,
        # show_column_dend = F,
          cluster_columns = F,
          cluster_rows = F)
draw(heatmap_obj, merge_legend = TRUE)
pdf("results/figures/cazyme_uniq_rpkm_no_unknown.pdf", width = 15, height = 25)
draw(heatmap_obj, merge_legend = TRUE)
dev.off()

```