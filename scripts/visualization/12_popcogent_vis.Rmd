```{r}
genus <- "g__Apibacter"
for (genus in genera){
    if (file.exists(paste0("results/12_PopCOGenT/", genus,"/", genus,".length_bias.txt"))) {
        df_vals <- read.csv(paste0("results/12_PopCOGenT/", genus,"/", genus,".length_bias.txt"), sep = "\t") %>%
                    select(Strain.1, Strain.2, Observed.SSD) %>%
                    mutate(Observed.SSD = as.numeric(Observed.SSD))

        df_cluster <- read.csv(paste0("results/12_PopCOGenT/", genus,"/", genus,"_0.000355362.txt.cluster.tab.txt"), sep = "\t") %>%
                                            select(Strain, Cluster_ID) %>%
                            arrange(Cluster_ID)
        mag_order <- df_cluster %>% pull(Strain)
        mag_order_1 <- mag_order[which(mag_order %in% df_vals$Strain.1)]
        mag_order_2 <- mag_order[which(mag_order %in% df_vals$Strain.2)]
        df_vals_mat <- df_vals %>%
                            pivot_wider(id_cols = "Strain.1", names_from = "Strain.2", values_from = "Observed.SSD") %>%
                            column_to_rownames("Strain.1") %>% 
                                as.matrix
        max_value <- max(df_vals$Observed.SSD, na.rm = T)
        df_vals_mat <- df_vals_mat[mag_order_1, mag_order_2]
        for (i in dim(df_vals_mat)[1]:1){
            for(j in dim(df_vals_mat)[2]:1){
                if(i == j){
                    df_vals_mat[i,j] <- max_value
                }
                if(is.na(df_vals_mat[i,j])){
                    df_vals_mat[i,j] <- df_vals_mat[j,i]
                }
            }
        }
        # make complex heatmap
        cluster_names <- df_vals_mat %>% rownames() %>% as.data.frame() %>% left_join(df_cluster, by = c("." = "Strain")) %>% pull(Cluster_ID)
        host_names <- df_vals_mat %>% rownames() %>% as.data.frame() %>% mutate(host = Vectorize(get_host_name)(.)) %>% pull(host)
        cluster_anno <- rowAnnotation(`cluster` = cluster_names,
                                    col = list(`cluster` = make_col_list(cluster_names, "Spectral")),
                                            border = TRUE
                    )
        host_anno <- rowAnnotation(`host` = host_names,
                                    col = list(`host` = host_order_color_dark),
                                            border = TRUE
                    )
        location_names <- df_vals_mat %>% rownames() %>% as.data.frame() %>% mutate(location = Vectorize(get_origin_name)(.)) %>% pull(location)
        location_anno <- rowAnnotation(`location` = location_names,
                                    col = list(`location` = make_col_list(location_names, "Pastel1")),
                                            border = TRUE
                    )
        cluster_names_col <- df_vals_mat %>% colnames() %>% as.data.frame() %>% left_join(df_cluster, by = c("." = "Strain")) %>% pull(Cluster_ID)
        cluster_anno_col <- HeatmapAnnotation(`cluster` = cluster_names_col,
                                    col = list(`cluster` = make_col_list(cluster_names_col, "Spectral")),
                                            border = TRUE
                    )
        col_split <- as.factor(cluster_names_col)
        row_split <- as.factor(cluster_names)
        heatmap_obj = Heatmap(df_vals_mat,
                    col = colorRamp2(c(0, 10, 100, 1000, 10000), c("#f2f2f2", "#9ecae1", "#4292c6", "#08306b", "#08306b")),
                    # bottom_annotation = bottom_annotation_obj,
                    # top_annotation = cluster_anno_col,
                    left_annotation = host_anno,
                    right_annotation = location_anno,
                    column_names_gp = grid::gpar(fontsize = 5),
                    row_names_gp = grid::gpar(fontsize = 5),
                    heatmap_legend_param = list(title = "Number genes copies"),
                    clustering_method_rows = "complete",
                    clustering_method_columns = "complete",
                    column_split = col_split,
                    row_split = row_split,
                    # column_title_rot = 90,
                    row_title_gp = grid::gpar(fontsize = 10),
                    border = T,
                    # row_dend_reorder = T,
                    cluster_columns = F,
                    cluster_rows = F
                    )
        draw(heatmap_obj, merge_legend = TRUE)
        pdf(paste0("results/figures/popcogent_mat/", genus,"_length_bias.pdf"), width = 20, height = 20)
        draw(heatmap_obj, merge_legend = TRUE)
        dev.off()
    }
}

```